{% extends "base.html" %}
{% block title %}Step Library{% endblock %}

{% block content %}
<h1>Step Library</h1>

{# Set variables needed for the 'Create New Step' form #}
{% set action_url = url_for('steps_library') %}
{% set button_text = 'Create New Step' %}
{# Explicitly set step to None for the create context to avoid ambiguity #}
{% set step = none %}
{# Now include the form - it will use the variables set above #}
{% include '_form_step.html' %} {# Line 12 (approx) after sets #}

<hr>

<h2>Existing Steps ({{ steps|length }})</h2>
{% if steps %}
<ul class="list-group library-list">
    {# The main loop variable is named 'step', which is convenient #}
    {% for step_item in steps %} {# Changed loop variable to avoid reusing 'step' name directly before setting context vars #}
    <li class="list-group-item" id="step-display-{{ step_item.id }}">
        <div>
            <span class="fw-bold">{{ step_item.icon }} {{ step_item.name }}</span>
            {% if step_item.estimated_time %} <small class="text-muted">({{ step_item.estimated_time }} min)</small>{% endif %}
             {% if step_item.description %} <br><small class="text-muted fst-italic">{{ step_item.description }}</small>{% endif %}
             {% if step_item.tags %} <br><small>{% for tag in step_item.tags.split(',') %}<span class="badge bg-info text-dark me-1">{{tag.strip()}}</span>{% endfor %}</small>{% endif %}
        </div>
        <div class="actions">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#editStepForm{{ step_item.id }}" aria-expanded="false" aria-controls="editStepForm{{ step_item.id }}">
                <i class="bi bi-pencil"></i> Edit
            </button>
            <form action="{{ url_for('delete_step', step_id=step_item.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete the step \'{{ step_item.name }}\'? This cannot be undone.');">
                <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </form>
        </div>
    </li>
    {# Collapsible Edit Form for each step #}
    <li class="list-group-item p-0 collapse" id="editStepForm{{ step_item.id }}">
         {# Set variables needed for the 'Edit Step' form #}
         {% set action_url = url_for('edit_step', step_id=step_item.id) %}
         {% set button_text = 'Save Changes' %}
         {# Set the 'step' variable specifically for the included context #}
         {% set step = step_item %}
         {# Now include the form - it will use the step_item passed as 'step', plus action_url and button_text #}
         {% include '_form_step.html' %} {# Line 44 (approx) after sets #}
    </li>

    {% endfor %} {# End of loop for step_item in steps #}
</ul>
{% else %}
<p class="text-muted">No steps created yet. Add one using the form above!</p>
{% endif %}

{% endblock %}


{% block scripts %}
{{ super() }} {# Include scripts from base.html if any #}
<script>
    // Ensure only one edit form is open at a time (optional UX improvement)
    const collapseElements = document.querySelectorAll('.collapse[id^="editStepForm"]'); // More specific selector
    collapseElements.forEach(el => {
        el.addEventListener('show.bs.collapse', event => {
            collapseElements.forEach(otherEl => {
                if (otherEl !== event.target && otherEl.classList.contains('show')) {
                    // Get the Bootstrap Collapse instance and hide it
                    const collapseInstance = bootstrap.Collapse.getInstance(otherEl);
                    if (collapseInstance) {
                        collapseInstance.hide();
                    }
                }
            });
        });
    });
</script>
{% endblock %}